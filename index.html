<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ear Training Game to improve your musical ear">

    <title>Ear Training Game</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="Assets/android-chrome-512x512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="Assets/android-chrome-192x192.png" sizes="192x192" type="image/png">
    <link rel="apple-touch-icon" href="Assets/android-chrome-192x192.png">

    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            font-family: sans-serif;
        }

        .keyboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .keyboard {
            display: flex;
            border: 2px solid black;
            padding: 20px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .octave {
            display: flex;
            position: relative;
        }

        .white {
            width: 60px;
            height: 240px;
            background-color: white;
            border: 1px solid black;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 1;
        }

        .black {
            width: 36px;
            height: 160px;
            background-color: black;
            position: absolute;
            z-index: 2;
            transform: translateX(-18px);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .c-sharp {left: 60px;}
        .d-sharp {left: 122px;}
        .f-sharp {left: 246px;}
        .g-sharp {left: 307px;}
        .a-sharp {left: 368px;}

        .octave-label {
            position: absolute;
            top: -22px;
            font-size: 20px;
            font-weight: bold;
        }

        .c4-label {color: blue;}
        .c5-label {color: red;}

        #top-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            text-align: center;
        }

        #info-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 16px;
        }

        #feedback {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .highlighted { background-color: lightblue !important; }
        .wrong-highlight { background-color: lightcoral !important; }

        #info-bar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 2000;
            display: flex;
            align-items: center;
            font-size: 16px;
            gap: 10px;
        }

        #info-icon {
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            background-color: #ddd;
            border-radius: 50%;
        }

        #info-box {
            display: none;
            position: absolute;
            top: 30px;
            left: 0;
            background-color: #fff;
            color: #333;
            border: 1px solid #aaa;
            padding: 10px;
            width: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        #orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 28px;
            text-align: center;
        }

        button {
            border-radius: 12px;
            padding: 10px 18px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #score, #high-score, #time-remaining {
            font-size: 22px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="info-bar">
    <span id="info-icon">ℹ️</span>
    <span id="branding">SRG774 - EarTraining 2026 ©</span>
    <div id="info-box">
        Welcome! Click "Start Game" to begin. A musical note will play—click the key that matches. Use "Recap Note" to hear it again.
    </div>
</div>

<div id="orientation-overlay">
    <p>Please rotate your device to landscape mode.</p>
</div>

<div class="keyboard-container">
    <div class="keyboard">
        <div class="octave">
            <div class="octave-label c4-label">C4</div>
            <div class="white" data-freq="261.63">C</div>
            <div class="black c-sharp" data-freq="277.18">C#<br>D♭</div>
            <div class="white" data-freq="293.66">D</div>
            <div class="black d-sharp" data-freq="311.13">D#<br>E♭</div>
            <div class="white" data-freq="329.63">E</div>
            <div class="white" data-freq="349.23">F</div>
            <div class="black f-sharp" data-freq="369.99">F#<br>G♭</div>
            <div class="white" data-freq="392.00">G</div>
            <div class="black g-sharp" data-freq="415.30">G#<br>A♭</div>
            <div class="white" data-freq="440.00">A</div>
            <div class="black a-sharp" data-freq="466.16">A#<br>B♭</div>
            <div class="white" data-freq="493.88">B</div>
        </div>
        <div class="octave">
            <div class="octave-label c5-label">C5</div>
            <div class="white" data-freq="523.25">C</div>
            <div class="black c-sharp" data-freq="554.37">C#<br>D♭</div>
            <div class="white" data-freq="587.33">D</div>
            <div class="black d-sharp" data-freq="622.25">D#<br>E♭</div>
            <div class="white" data-freq="659.26">E</div>
            <div class="white" data-freq="698.46">F</div>
            <div class="black f-sharp" data-freq="739.99">F#<br>G♭</div>
            <div class="white" data-freq="783.99">G</div>
            <div class="black g-sharp" data-freq="830.61">G#<br>A♭</div>
            <div class="white" data-freq="880.00">A</div>
            <div class="black a-sharp" data-freq="932.33">A#<br>B♭</div>
            <div class="white" data-freq="987.77">B</div>
        </div>
    </div>
</div>

<div id="top-bar">
    <button id="start-game-button" disabled>Loading Sounds...</button>
    <button id="recap-button">Recap Note</button>
    <button id="play-again-button" style="display: none;">Play Again</button>
    <button id="play-all-notes-button">Play All Notes</button>
    <div id="info-group">
        <span id="score">Score: 0</span>
        <span id="high-score">High Score: 0</span>
        <span id="time-remaining">Time: 90</span>
    </div>
</div>

<p id="feedback"></p>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let score = 0;
    let highScore = 0;
    let timeLeft = 90;
    let timer;
    let targetFrequency;
    let inputEnabled = false; // Start disabled until buffers load

    const allFrequencies = [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88, 523.25, 554.37, 587.33, 622.25, 659.26, 698.46, 739.99, 783.99, 830.61, 880.00, 932.33, 987.77];
    const keyElements = document.querySelectorAll('.white, .black');
    const noteBuffers = {};
    const noteFiles = {
        "261.63": "Assets/C4.wav", "277.18": "Assets/C4-sharp.wav", "293.66": "Assets/D4.wav",
        "311.13": "Assets/D4-sharp.wav", "329.63": "Assets/E4.wav", "349.23": "Assets/F4.wav",
        "369.99": "Assets/F4-sharp.wav", "392.00": "Assets/G4.wav", "415.30": "Assets/G4-sharp.wav",
        "440.00": "Assets/A4.wav", "466.16": "Assets/A4-sharp.wav", "493.88": "Assets/B4.wav",
        "523.25": "Assets/C5.wav", "554.37": "Assets/C5-sharp.wav", "587.33": "Assets/D5.wav",
        "622.25": "Assets/D5-sharp.wav", "659.26": "Assets/E5.wav", "698.46": "Assets/F5.wav",
        "739.99": "Assets/F5-sharp.wav", "783.99": "Assets/G5.wav", "830.61": "Assets/G5-sharp.wav",
        "880.00": "Assets/A5.wav", "932.33": "Assets/A5-sharp.wav", "987.77": "Assets/B5.wav"
    };

    // Load buffers with error checking
    async function loadBuffers() {
        const startBtn = document.getElementById('start-game-button');
        try {
            const promises = Object.keys(noteFiles).map(async (freq) => {
                const response = await fetch(noteFiles[freq]);
                if (!response.ok) throw new Error(`Missing: ${noteFiles[freq]}`);
                const arrayBuffer = await response.arrayBuffer();
                noteBuffers[freq] = await audioCtx.decodeAudioData(arrayBuffer);
            });

            await Promise.all(promises);
            
            startBtn.disabled = false;
            startBtn.textContent = "Start Game";
            inputEnabled = true;
            console.log("All audio buffers loaded successfully.");
        } catch (err) {
            console.error("Audio Load Error:", err);
            startBtn.textContent = "Error Loading Audio";
        }
    }

    function playBuffer(buffer) {
        if (!buffer) return;
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start();
    }

    function playNote(frequency) {
        const freqString = parseFloat(frequency).toFixed(2);
        if (noteBuffers[freqString]) {
            playBuffer(noteBuffers[freqString]);
        } else {
            console.error('Audio buffer not loaded for frequency:', freqString);
        }
    }

    // Feedback sounds using Oscillators
    function playFeedbackSound(type) {
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = (type === 'correct') ? 'sine' : 'triangle';
        osc.frequency.setValueAtTime((type === 'correct') ? 440 : 220, now);
        gain.gain.setValueAtTime(0.5, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.5);
    }

    async function startGame() {
        // Essential: Resume context on user click
        if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }

        score = 0;
        timeLeft = 90;
        updateScore();
        updateTimer();
        playTargetNote();
        
        document.getElementById('play-again-button').style.display = 'none';
        document.getElementById('feedback').textContent = "";
        document.getElementById('start-game-button').disabled = true;
        
        inputEnabled = true;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            updateTimer();
            if (timeLeft <= 0) {
                clearInterval(timer);
                inputEnabled = false;
                document.getElementById('play-again-button').style.display = 'block';
                document.getElementById('start-game-button').disabled = false;
            }
        }, 1000);
    }

    function playTargetNote() {
        targetFrequency = allFrequencies[Math.floor(Math.random() * allFrequencies.length)];
        playNote(targetFrequency);
    }

    function handleUserInput(frequency) {
        if (!inputEnabled) return;

        if (Math.abs(targetFrequency - frequency) < 0.1) {
            score++;
            playFeedbackSound('correct');
            updateScore();
            highlightKey(frequency, 'highlighted');
            inputEnabled = false;
            setTimeout(() => {
                if (timeLeft > 0) {
                    playTargetNote();
                    inputEnabled = true;
                }
            }, 800);
        } else {
            playFeedbackSound('wrong');
            highlightKey(frequency, 'wrong-highlight');
        }
    }

    function highlightKey(frequency, className) {
        keyElements.forEach(key => {
            if (parseFloat(key.dataset.freq) === frequency) {
                key.classList.add(className);
                setTimeout(() => key.classList.remove(className), 500);
            }
        });
    }

    // Event Listeners
    keyElements.forEach(key => {
        key.addEventListener('click', () => handleUserInput(parseFloat(key.dataset.freq)));
    });

    document.getElementById('start-game-button').addEventListener('click', startGame);
    document.getElementById('play-again-button').addEventListener('click', startGame);
    document.getElementById('recap-button').addEventListener('click', () => {
        if (targetFrequency) playNote(targetFrequency);
    });

    document.getElementById('play-all-notes-button').addEventListener('click', async () => {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        let delay = 0;
        const btn = document.getElementById('play-all-notes-button');
        btn.disabled = true;
        allFrequencies.forEach((freq) => {
            setTimeout(() => {
                playNote(freq);
                highlightKey(freq, 'highlighted');
            }, delay);
            delay += 500;
        });
        setTimeout(() => btn.disabled = false, delay);
    });

    function updateScore() {
        document.getElementById('score').textContent = `Score: ${score}`;
        if (score > highScore) {
            highScore = score;
            document.getElementById('high-score').textContent = `High Score: ${highScore}`;
        }
    }

    function updateTimer() {
        document.getElementById('time-remaining').textContent = `Time: ${timeLeft}`;
    }

    // Info Box toggle
    document.getElementById('info-icon').addEventListener('click', () => {
        const box = document.getElementById('info-box');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    });

    // Orientation Logic
    function checkOrientation() {
        const isLandscape = window.innerWidth > window.innerHeight;
        const overlay = document.getElementById('orientation-overlay');
        overlay.style.display = (window.innerWidth < 600 && !isLandscape) ? 'flex' : 'none';
    }

    window.addEventListener('resize', checkOrientation);
    window.addEventListener('DOMContentLoaded', () => {
        checkOrientation();
        loadBuffers();
    });
</script>
</body>
</html>
