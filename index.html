<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ear Training Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=no">
  <style>
    /* Your original styling goes here (unchanged) */
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
      font-family: sans-serif;
    }
    /* ... */
  </style>
</head>
<body>

  <div id="orientation-overlay" style="display: none;">
    <p>Please rotate your device to landscape mode for the best experience.</p>
    <svg viewBox="0 0 64 32" width="64" height="32" fill="white">
      <rect x="5" y="8" width="54" height="16" rx="2" ry="2" />
      <rect x="2" y="6" width="6" height="20" rx="1" ry="1" />
      <rect x="56" y="6" width="6" height="20" rx="1" ry="1" />
    </svg>
  </div>

  <div class="keyboard-container">
    <div class="keyboard">
      <!-- Your original keyboard layout goes here (unchanged) -->
    </div>
  </div>

  <div id="top-bar">
    <button id="start-game-button">Start Game</button>
    <button id="recap-button">Recap Note</button>
    <button id="play-again-button" style="display: none;">Play Again</button>
    <button id="play-all-notes-button">Play All Notes</button>
    <div id="info-group">
      <span id="score">Score: 0</span>
      <span id="high-score">High Score: 0</span>
      <span id="time-remaining">Time: 90</span>
    </div>
  </div>

  <p id="feedback"></p>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const noteBuffers = {};

    const noteFiles = {
      "C4": "Assets/C4.wav", "C4-sharp": "Assets/C4-sharp.wav", "D4": "Assets/D4.wav",
      "D4-sharp": "Assets/D4-sharp.wav", "E4": "Assets/E4.wav", "F4": "Assets/F4.wav",
      "F4-sharp": "Assets/F4-sharp.wav", "G4": "Assets/G4.wav", "G4-sharp": "Assets/G4-sharp.wav",
      "A4": "Assets/A4.wav", "A4-sharp": "Assets/A4-sharp.wav", "B4": "Assets/B4.wav",
      "C5": "Assets/C5.wav", "C5-sharp": "Assets/C5-sharp.wav", "D5": "Assets/D5.wav",
      "D5-sharp": "Assets/D5-sharp.wav", "E5": "Assets/E5.wav", "F5": "Assets/F5.wav",
      "F5-sharp": "Assets/F5-sharp.wav", "G5": "Assets/G5.wav", "G5-sharp": "Assets/G5-sharp.wav",
      "A5": "Assets/A5.wav", "A5-sharp": "Assets/A5-sharp.wav", "B5": "Assets/B5.wav"
    };

    const chromaticNotes = [
      "C4", "C4-sharp", "D4", "D4-sharp", "E4",
      "F4", "F4-sharp", "G4", "G4-sharp", "A4", "A4-sharp", "B4",
      "C5", "C5-sharp", "D5", "D5-sharp", "E5",
      "F5", "F5-sharp", "G5", "G5-sharp", "A5", "A5-sharp", "B5"
    ];

    async function loadBuffers() {
      for (const note in noteFiles) {
        const response = await fetch(noteFiles[note]);
        const arrayBuffer = await response.arrayBuffer();
        noteBuffers[note] = await audioContext.decodeAudioData(arrayBuffer);
      }
    }

    function playNoteAtTime(note, time) {
      const buffer = noteBuffers[note];
      if (buffer) {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(time);
      }
    }

    function playRewardSound() {
      const now = audioContext.currentTime;
      const freqs = [523.25, 659.25, 783.99]; // C5, E5, G5
      freqs.forEach((freq, i) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();

        osc.type = "sine";
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0.67, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);

        osc.connect(gain).connect(audioContext.destination);
        osc.start(now + i * 0.03);
        osc.stop(now + 1);
      });
    }

    function playMistakeSound() {
      const now = audioContext.currentTime;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(261.63, now); // C4
      gain.gain.setValueAtTime(0.67, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);

      osc.connect(gain).connect(audioContext.destination);
      osc.start(now);
      osc.stop(now + 0.7);
    }

    // Existing game logic here (unchanged)

    // Replace playNote with the new playNoteAtTime function
    function playNote(frequency) {
      const note = getNoteFromFrequency(frequency);
      if (note) {
        playNoteAtTime(note, audioContext.currentTime);
      }
    }

    function getNoteFromFrequency(frequency) {
      // A basic mapping of frequencies to note names
      const frequencyToNote = {
        261.63: "C4", 277.18: "C4-sharp", 293.66: "D4", 311.13: "D4-sharp",
        329.63: "E4", 349.23: "F4", 369.99: "F4-sharp", 392.00: "G4",
        415.30: "G4-sharp", 440.00: "A4", 466.16: "A4-sharp", 493.88: "B4",
        523.25: "C5", 554.37: "C5-sharp", 587.33: "D5", 622.25: "D5-sharp",
        659.26: "E5", 698.46: "F5", 739.99: "F5-sharp", 783.99: "G5",
        830.61: "G5-sharp", 880.00: "A5", 932.33: "A5-sharp", 987.77: "B5"
      };
      return frequencyToNote[frequency];
    }

    // Add event listeners and other existing game logic as needed
    document.getElementById('start-game-button').addEventListener('click', startGame);
    document.getElementById('recap-button').addEventListener('click', () => {
      if (targetFrequency) {
        playNote(targetFrequency);
      }
    });
    document.getElementById('play-again-button').addEventListener('click', startGame);
    document.getElementById('play-all-notes-button').addEventListener('click', () => {
      let delay = 0;
      chromaticNotes.forEach((note) => {
        setTimeout(() => {
          playNoteAtTime(note, audioContext.currentTime + delay / 1000);
        }, delay);
        delay += 600;
      });
    });

    window.addEventListener("load", loadBuffers);

  </script>
</body>
</html>
